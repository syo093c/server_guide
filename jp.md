---
title: "サーバー管理ガイド"
titlepage: true
...
## 第1章: アカウント管理

計算資源を必要とする学生にアカウントを作成し、サーバーへのログインとリソースの利用を許可します。

### ユーザーの追加

新しいユーザーを追加するには、以下のコマンドを使用します。

```bash
useradd -m <ユーザー名>
```

### ユーザーパスワードの設定

新しいユーザーのパスワードを設定します。

```bash
passwd <ユーザー名>
```

### **注意**: sudo権限の付与

sudo権限を付与すると、ユーザーは管理者権限でコマンドを実行できます。慎重に以下のコマンドを使用してください。

```bash
usermod -aG sudo <ユーザー名>
```

### SSH鍵認証の設定

セキュリティを強化するため、SSHの鍵認証を設定し、パスワード認証を無効にすることを検討してください。

1. **クライアント側でSSH鍵を生成**

   ユーザーのクライアントマシンで、SSH鍵ペアを生成します。

   ```bash
   ssh-keygen
   ```

2. **サーバーに公開鍵をアップロード**

   公開鍵をサーバーにアップロードし、鍵認証によるログインを有効にします。

   ```bash
   ssh-copy-id -i <公開鍵ファイル> <ユーザー名>@<サーバーのIPアドレス>
   ```

   または、サーバーのauthorized_keysファイルに公開鍵を手動で追加します。

   ```bash
   echo <公開鍵の内容> >> /home/<ユーザー名>/.ssh/authorized_keys
   ```

---

## 第2章: 環境構築

ユーザーのPython環境管理に**conda**を使用します。

condaはPython環境に特化したパッケージマネージャーで、複数の独立した（仮想）Python環境を作成・管理できます。パッケージは「チャネル」または「ソース」と呼ばれるリポジトリからダウンロードされ、オープンソース（例: conda-forge）やプロプライエタリ（例: Anaconda）があります。

### Miniforgeのインストール

1. **Miniforgeインストールスクリプトのダウンロード**

   ```bash
   wget https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-x86_64.sh
   ```

2. **インストールスクリプトの実行**

   ```bash
   bash Miniforge3-Linux-x86_64.sh
   ```

3. **ベース環境の自動アクティベーションを無効化**

   システムのPythonに依存するソフトウェアとの競合を避けるため、condaがベース環境を自動的にアクティブにしないよう設定します。

   ```bash
   conda config --set auto_activate_base false
   ```

### 新しい環境の作成とアクティベーション

1. **新しい環境の作成**

   ```bash
   conda create -n py310 python=3.10
   ```

2. **新しい環境のアクティブ化**

   ```bash
   conda activate py310
   ```

### PyTorchのインストール

CUDAバージョンとの互換性を確認しながら、公式の手順に従ってPyTorchをインストールします。(pipを使用してください。)

- [PyTorch公式サイト](https://pytorch.org/)にアクセスし、適切なインストールガイドに従ってください。

---

## 第3章: パッケージ管理

この章は、システムパッケージをインストールおよび管理する管理者向けです。

UbuntuはDebianベースのディストリビューションで、`.deb`パッケージ形式を使用します。パッケージのインストール、削除、クエリには、**dpkg**（バックエンド）と**apt**（フロントエンド）のパッケージマネージャーを使用します。

### aptの一般的なコマンド

- **パッケージインデックスの更新**

  ```bash
  sudo apt update
  ```

- **インストール済みパッケージのアップグレード**

  ```bash
  sudo apt upgrade
  ```

- **特定のパッケージのインストール**

  ```bash
  sudo apt install <パッケージ名>
  ```

- **ローカルの.debファイルのインストール**

  ```bash
  sudo apt install ./path/to/package.deb
  ```

- **インストール済みパッケージの削除（設定ファイルを保持）**

  ```bash
  sudo apt remove <パッケージ名>
  ```

- **インストール済みパッケージとその設定ファイルの削除**

  ```bash
  sudo apt purge <パッケージ名>
  ```

- **不要なパッケージの自動削除**

  ```bash
  sudo apt autoremove
  ```

- **パッケージの検索**

  ```bash
  apt search <パッケージ名>
  ```

### 依存関係の問題解決

システムパッケージは複雑な依存関係を持つことが多く、依存関係が満たされない場合、インストールや削除、アップデート中に問題が発生することがあります。

#### 依存関係問題を解決する手順

1. **パッケージインデックスの更新**

   パッケージインデックスを最新の状態に保ちます。

   ```bash
   sudo apt update
   ```

2. **`aptitude`を使用して自動的に依存関係を解決**

   `aptitude`がインストールされていない場合は、以下でインストールします。

   ```bash
   sudo apt install aptitude
   ```

   `aptitude`で自動解決を試みます。

   ```bash
   sudo aptitude install <パッケージ名>
   ```

3. **エラーメッセージに基づいて手動で競合を解決**

   - **エラーメッセージを注意深く読む**

     どのパッケージが競合しているかを特定し、原因を理解します。

   - **考えられる原因を検討**

     - 循環依存
     - リポジトリに比べて古いパッケージインデックス
     - 手動でインストールしたサードパーティ製パッケージ

   - **必要なパッケージバージョンを特定**

     必要なバージョンを確認し、取得方法を決定します（例: インデックスを更新してリポジトリからダウンロード、循環依存のパッケージを一旦削除してリポジトリからダウンロード、または[pkgs.org](https://pkgs.org/)で検索）。

### 参考資料

- **Debianパッケージングチュートリアル**

  - [Debianパッケージングチュートリアル（PDF）](https://www.debian.org/doc/manuals/packaging-tutorial/packaging-tutorial.ja.pdf)

- **Debianパッケージ管理ツール**

  - [Debian FAQ: パッケージツール](https://www.debian.org/doc/manuals/debian-faq/pkgtools.ja.html)
  - [Debian FAQ: パッケージ管理システムの基本](https://www.debian.org/doc/manuals/debian-faq/pkg-basics.ja.html#depends)

---

## 第4章: **注意**: リバースプロキシの設定

この章は、学外からサーバーにアクセスする必要があるユーザー向けです。

特定の環境では、サーバーがローカルエリアネットワーク（LAN）内にあり、ファイアウォールによって保護されています。外部から内部マシンへのアクセスはブロックされていますが、内部マシンはインターネットにアクセスできます。LANの外部からサーバーにアクセスするには、ネットワークトンネルを使用する必要があります。

### 概要

パブリックIPアドレスを持つ仮想プライベートサーバー（VPS）を利用して接続を確立します。

- **計算サーバー**: アクセスしたい内部サーバー
- **VPS**: 公開IPアドレスを持つサーバー
- **クライアント**: 計算サーバーにアクセスするマシン

#### 接続フロー

1. **計算サーバーとVPS間で接続`a`を確立**

   - 計算サーバーがVPSの指定ポートに持続的な接続を確立します。

2. **VPSがポート`8080`でリスニング**

   - VPSはポート`8080`で受信したトラフィックを接続`a`を通じて計算サーバーに転送します。

3. **計算サーバーがポート`22`（SSHポート）でトラフィックを受信**

   - クライアントはVPSのポート`8080`に接続し、それが計算サーバーのポート`22`に転送されます。

**図**:

```
(クライアント)(local_port) <------> (8090)(VPS)(8080) <---[接続a]---> (local_port)(計算サーバー)(22)
```

### frpを使用したネットワークトンネルの構築

ネットワークトンネルの設定には、**frp**（Fast Reverse Proxy）を使用します。

#### VPSサーバー上でのfrpsのデプロイ

`frps.ini`という設定ファイルを作成し、以下の内容を記述します。

```ini
[common]
bind_addr = 0.0.0.0
bind_port = 8080
authentication_method = token
authenticate_heartbeats = true
authenticate_new_work_conns = true
token = "あなたの安全なトークン"
log_file = "./frps.log"
```

**frpsの起動**:

```bash
frps -c frps.ini
```

#### 計算サーバー上でのfrpcのデプロイ

`frpc.ini`という設定ファイルを作成し、以下の内容を記述します。

```ini
[common]
server_addr = "<VPSのパブリックIPアドレス>"
server_port = 8080
authentication_method = token
token = "あなたの安全なトークン"

[ssh]
type = tcp
local_ip = 127.0.0.1
local_port = 22
remote_port = 8090
```

**frpcの起動**:

```bash
frpc -c frpc.ini
```

#### クライアントからの接続

ローカルマシンから、VPS経由で計算サーバーに接続します。

```bash
ssh -p 8090 <ユーザー名>@<VPSのパブリックIPアドレス>
```

### **注意**: セキュリティ対策

- **強力な認証トークンを設定**

  `token`には強力でユニークな値を設定し、frpサービスのセキュリティを確保します。
  例:`940142B3-6653-4000-ACB7-F203CA3E7456`

- **frpを定期的に更新**

  セキュリティパッチや改善を受けるため、frpを最新の状態に保ちます。

- **パスワード認証を無効化**

  [第1章](#第1章-アカウント管理)で述べたように、SSHのパスワード認証を無効化し、鍵認証を強制します。

  計算サーバーの`/etc/ssh/sshd_config`ファイルで以下を設定します。

  ```ini
  PasswordAuthentication no
  ```

  SSHサービスを再起動します。

  ```bash
  sudo systemctl restart ssh
  ```

---

**注記**: 内部サービスを外部ネットワークに公開する際は常に注意が必要です。すべての設定が組織のセキュリティポリシーに準拠していることを確認してください。

---
